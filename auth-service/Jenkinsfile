pipeline {
  agent any

  options {
    timestamps()
    disableConcurrentBuilds()
  }

  environment {
    DOCKERHUB_USER = "ahmed3sjsu"
    SERVICE_NAME   = "auth-service"
    IMAGE          = "docker.io/${DOCKERHUB_USER}/${SERVICE_NAME}"
    TAG            = "${env.GIT_COMMIT}".take(7)

    // GitOps uses the DEV-PROJECT monorepo
    GITOPS_REPO_SSH = "git@github.com:ahmedabdelrahman-del/DEV-PROJECT.git"
    GITOPS_BRANCH   = "main"
    // Path to kustomization.yaml inside that repo
    GITOPS_PATH     = "gitops/apps/${SERVICE_NAME}/overlays/dev/kustomization.yaml"

    DOCKERHUB_CRED  = "dockerhub-creds"
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Go format (check)') {
      steps {
        dir("${SERVICE_NAME}") {
          sh 'test -z "$(gofmt -l .)"'
        }
      }
    }

    stage('Go vet') {
      steps {
        dir("${SERVICE_NAME}") {
          sh 'go vet ./...'
        }
      }
    }

    stage('Unit tests') {
      steps {
        dir("${SERVICE_NAME}") {
          sh 'go test ./...'
        }
      }
    }

    stage('Build & Push image') {
      steps {
        withCredentials([usernamePassword(credentialsId: "${DOCKERHUB_CRED}", usernameVariable: "DOCKER_USER", passwordVariable: "DOCKER_PASS")]) {
          sh '''
            set -euo pipefail
            echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin

            export DOCKER_BUILDKIT=1
            docker build -t "${IMAGE}:${TAG}" -t "${IMAGE}:latest" "${SERVICE_NAME}"
            docker push "${IMAGE}:${TAG}"
            docker push "${IMAGE}:latest"

            docker logout
          '''
        }
      }
    }

    stage('Update GitOps (dev)') {
  steps {
    sshagent(credentials: ['gitops-repo-ssh']) {
      sh '''
        set -euo pipefail
        rm -rf gitops
        git clone -b "${GITOPS_BRANCH}" "${GITOPS_REPO_SSH}" gitops
        cd gitops

        if command -v yq >/dev/null 2>&1; then
          # Prefer YAML-aware updates when available.
          yq -i '.images[].newTag = strenv(TAG)' "${GITOPS_PATH}"
        else
          # Fallback (best-effort): replace the first newTag entry.
          sed -i.bak '0,/newTag:/s/newTag: .*/newTag: "'"${TAG}"'"/' "${GITOPS_PATH}"
        fi

        git config user.email "jenkins@local"
        git config user.name  "jenkins"

        git add "${GITOPS_PATH}"
        git commit -m "${SERVICE_NAME}: bump image tag to ${TAG}" || true
        git push origin "${GITOPS_BRANCH}"
      '''
    }
  }
}

    stage('E2E (local smoke)') {
      steps {
        sh 'bash ci/e2e-smoke-local.sh'
      }
    }

  }

  post {
    always {
      cleanWs()
    }
  }
}
